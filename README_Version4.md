# مستند جامع و فنی پیاده‌سازی وایت‌لیست شرکت‌های تولیدی

این پروژه برای مدیریت و نمایش وایت‌لیست شرکت‌های تولیدی با قابلیت جستجو و فیلتر اطلاعات کلیدی هر شرکت توسعه یافته است. این مستند تمام جزئیات فنی، شروط، مراحل اجرا، تست و نگهداری را برای توسعه‌دهندگان بعدی فراهم می‌کند.

---

## ۱. شرح نیازمندی و اهداف

- **هدف پروژه:**  
  نمایش لیست شرکت‌های مجاز تولیدی به صورت جدول واکنش‌گرا، با قابلیت جستجو و فیلتر بر اساس نام شرکت و مدیر.
- **دیتابیس مرجع:**  
  جدول factories_whitelist (در MySQL/MariaDB)
- **اطلاعات نمایشی هر شرکت:**  
  - شناسه ملی (national_code یا نام دقیق ستون)
  - نام سایت تولیدی (factory_name_fa)
  - نوع صنعت تولیدی (manufacturing_industry_type)
  - نوع سایت تولیدی (production_site_type)
  - نام مدیر (manager_name_fa)
- **شرط کلیدی:**  
  هر شرکت فقط یکبار در خروجی جدول دیده شود (بر اساس نام شرکت)، داده‌ها از جدول factories_whitelist گرفته شود.

---

## ۲. آماده‌سازی اولیه و پیش‌نیازها

- **فایل‌های اصلی پروژه:**  
  - `whitelist.html` : صفحه اصلی نمایش جدول و فرم جستجو
  - `assets/js/whitelist.js` : مدیریت دریافت داده و نمایش جدول و جستجو
  - `api/whitelist.php` : API دریافت داده از دیتابیس و ارسال به فرانت‌اند
  - `_db.php` : مدیریت اتصال به دیتابیس (اطلاعات اتصال باید دقیق باشد)
- **ساختار جدول دیتابیس:**  
  ابتدا با اجرای دستور زیر در phpMyAdmin، نام و وجود ستون‌ها را کنترل کن:
  ```sql
  SHOW COLUMNS FROM factories_whitelist;
  ```
  و سپس داده تستی با دستور زیر بررسی شود:
  ```sql
  SELECT * FROM factories_whitelist LIMIT 10;
  ```
- **اطمینان از موارد زیر:**  
  - جدول factories_whitelist موجود باشد و حداقل چند رکورد تستی داشته باشد.
  - نام ستون‌ها کاملاً با کوئری و کدها مطابقت داشته باشد (تایپ اشتباه نشود).
  - فایل `_db.php` اطلاعات اتصال صحیح داشته باشد و به دیتابیس پروژه متصل شود.

---

## ۳. پیاده‌سازی و شروط فنی API

- **کد PHP (api/whitelist.php):**
  - اتصال به دیتابیس از طریق `_db.php` و مدیریت خطا
  - کوئری اصلی:
    ```sql
    SELECT national_code, factory_name_fa, manufacturing_industry_type, production_site_type, manager_name_fa
    FROM factories_whitelist
    GROUP BY factory_name_fa
    LIMIT 100
    ```
    > **نکته:** اگر نام ستون national_code وجود نداشت، نام صحیح جایگزین شود.
  - مدیریت خطا:
    - اگر کوئری اجرا نشد یا ستون وجود نداشت، خروجی JSON با شرح خطا ارسال شود:
      ```php
      if (!$res) {
        echo json_encode(['error' => $m->error, 'sql' => $sql]);
        exit;
      }
      ```
  - تبدیل داده‌ها به JSON و ارسال به فرانت‌اند با utf-8 و بدون escape یونیکد

- **شروط اجرایی:**
  - فقط داده‌های جدول factories_whitelist نمایش داده شود.
  - ستون‌ها باید دقیقاً با نام‌های جدول مطابقت داشته باشند.
  - هر شرکت فقط یکبار در خروجی باشد (GROUP BY بر اساس نام شرکت).
  - محدودیت تعداد خروجی برای بهبود کارایی (LIMIT).
  - اگر داده‌ای نیست یا خطا دارد، پیام واضح ارسال شود.

---

## ۴. پیاده‌سازی و شروط فنی فرانت‌اند

- **صفحه whitelist.html:**
  - بارگذاری داینامیک منو و فوتر (در صورت نیاز، با fetch از فایل‌های جداگانه).
  - فرم جستجو با input و دکمه، با idهای ثابت (`wl-q` و `wl-search`).
  - محل نمایش جدول با id `wl-results`.
  - استایل واکنش‌گرا و مدرن برای جدول و فرم جستجو با CSS داخلی یا خارجی.

- **کد جاوااسکریپت (assets/js/whitelist.js):**
  - دریافت داده از API با fetch و تبدیل به JSON.
  - ساخت جدول HTML با ستون‌های مورد نیاز و جایگزینی مقادیر null یا خالی با "-".
  - نمایش پیام خطا اگر خروجی JSON نبود یا داده‌ای نبود (مثلاً "داده‌ای یافت نشد").
  - جستجو با کلیک روی دکمه یا فشردن Enter در input فعال باشد (در صورت پیاده‌سازی سرچ سروری).
  - جدول واکنش‌گرا باشد و در موبایل و دسکتاپ خوانا بماند.

- **شروط اجرایی:**
  - هرگونه خطا در دریافت داده یا خروجی API باید به صورت پیام واضح نمایش داده شود.
  - قابلیت جستجو فعال باشد و نتیجه جستجو در جدول نمایش داده شود.
  - جدول باید مرتب و خوانا باشد و ستون‌ها به ترتیب مورد نظر نمایش داده شوند.
  - پیام‌های خطا و نبود داده به زبان فارسی و قابل فهم باشد.

---

## ۵. تست، عیب‌یابی و سناریوهای رفع خطا

- **تست مستقیم API:**  
  آدرس `/api/whitelist.php` را در مرورگر باز کن. خروجی باید JSON معتبر باشد، مثل:
  ```json
  [
    {"national_code":"1234567890", "factory_name_fa":"شرکت نمونه", ...}
  ]
  ```
  اگر خروجی خالی یا خطا بود، باید در phpMyAdmin کوئری را تست و مشکل را رفع کنی.

- **تست کوئری دیتابیس:**  
  در phpMyAdmin این کوئری را اجرا کن:
  ```sql
  SELECT national_code, factory_name_fa, manufacturing_industry_type, production_site_type, manager_name_fa FROM factories_whitelist LIMIT 10;
  ```
  اگر خطا یا خروجی خالی بود:
    - نام ستون‌ها را دوباره چک کن.
    - داده تستی وارد کن.
    - شرط یا GROUP BY را موقتاً حذف کن و مجدد تست بزن.

- **رفع خطاهای رایج:**
  - پیام `Unknown column '...' in 'SELECT'` یعنی نام ستون را اصلاح کن و دقیق بنویس.
  - پیام "داده‌ای یافت نشد" یعنی جدول خالی است یا کوئری هیچ داده‌ای برنمی‌گرداند.
  - پیام "خطا در دریافت اطلاعات یا خروجی JSON ندارد" یعنی API خروجی JSON معتبر ندارد (خطای PHP یا دیتابیس).

- **تست جستجو و واکنش‌گرایی:**  
  - مقدار جستجو را وارد کن و مطمئن شو داده‌ها فیلتر می‌شوند.
  - صفحه را روی موبایل و دسکتاپ بررسی کن تا جدول و فرم جستجو درست نمایش داده شود.

---

## ۶. چک‌لیست اجرایی و توسعه

- [ ] جدول factories_whitelist وجود دارد و داده تستی دارد.
- [ ] نام ستون‌ها دقیقاً با جدول مطابقت دارد.
- [ ] اتصال دیتابیس در _db.php درست است و به دیتابیس اصلی پروژه متصل می‌شود.
- [ ] خروجی API در مرورگر JSON معتبر است و خطا ندارد.
- [ ] کد جاوااسکریپت داده را دریافت و جدول را نمایش می‌دهد.
- [ ] فرم جستجو فعال است و داده‌ها فیلتر می‌شوند (در صورت نیاز).
- [ ] پیام‌های خطا و نبود داده به زبان فارسی و خوانا نمایش داده می‌شود.
- [ ] جدول واکنش‌گرا است و در موبایل و دسکتاپ درست دیده می‌شود.

---

## ۷. توصیه‌های نگهداری و توسعه آینده

- قبل از هر تغییر در دیتابیس یا کدها، نام ستون‌ها را دقیقاً بررسی و مستند کن.
- هرگونه تغییر در ساختار جدول یا ستون‌ها باید همزمان در کوئری API و کد JS اعمال شود.
- قبل از انتشار، پروژه را با داده تستی کاملاً بررسی و تست کن.
- برای افزودن قابلیت‌های جدید (مانند فیلتر پیشرفته، اکسپورت، ویرایش)، کدها را ماژولار و قابل توسعه نگهدار.
- مستندات و گزارش اقدامات را به‌روزرسانی کن تا توسعه‌دهندگان بعدی بتوانند به راحتی پروژه را ادامه دهند.

---

## ۸. مستند اقدامات فنی و تصمیمات مهم

- بررسی اولیه جداول و اصلاح مسیر دریافت داده از factories_raw به factories_whitelist
- رفع خطاهای مربوط به نبودن ستون یا تایپ اشتباه با تست در phpMyAdmin و اصلاح کوئری‌ها
- توسعه API با مدیریت خطا و ارسال خروجی JSON استاندارد
- توسعه فرانت‌اند با فرم جستجو و جدول واکنش‌گرا و مدرن
- تست کامل سناریوهای خطا، نبود داده و جستجو
- مستندسازی کامل شرایط اجرایی، چک‌لیست پیاده‌سازی و توصیه‌های نگهداری

---

**این مستند برای اجرا، توسعه، تست و نگهداری پروژه وایت‌لیست شرکت‌های تولیدی تهیه شده و هر توسعه‌دهنده‌ای با مطالعه آن قادر به پیاده‌سازی کامل و رفع اشکال خواهد بود.**